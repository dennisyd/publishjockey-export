% Custom LaTeX template for PublishJockey
% This template handles all formatting for PDF exports

\documentclass[$if(fontsize)$$fontsize$,$endif$$if(papersize)$$papersize$paper,$endif$$for(classoption)$$classoption$$sep$,$endfor$]{$documentclass$}

% Note: Using book class for proper front/main matter handling

\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript



% --- Load fancyhdr for page styling ---
\usepackage{fancyhdr}

\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[$if(fontenc)$$fontenc$$else$T1$endif$]{fontenc}
  \usepackage[utf8]{inputenc}
$if(euro)$
  \usepackage{eurosym}
$endif$
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
$for(fontfamilies)$
  \newfontfamily{$fontfamilies.name$}[$fontfamilies.options$]{$fontfamilies.font$}
$endfor$
$if(euro)$
  \newcommand{\euro}{â‚¬}
$endif$

% --- Additional font setup for RTL languages and Hindi ---
$if(dir)$
\ifxetex
  % Ensure proper font loading for RTL languages
  $if(mainfont)$
  \setmainfont{$mainfont$}
  $endif$
  % Additional font features for RTL languages
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
  % Explicit font loading for RTL languages
  \newfontfamily\arabicfont[Script=Arabic]{Noto Sans Arabic}
  \newfontfamily\hebrewfont[Script=Hebrew]{Noto Sans Hebrew}
\fi
$endif$

% --- SCRIPT-BASED FONT SWITCHING (NEW FEATURE) ---
$if(script-switching)$
% Use ucharclasses for automatic script-based font switching
\usepackage{ucharclasses}

% Set the script font as main font (default for all text)
\setmainfont{$script-font$}[
  Script=$script-name$,
  Renderer=HarfBuzz,
  Ligatures=TeX,
  Scale=MatchLowercase$if(script-language)$,
  Language=$script-language$$endif$
]

% Define Latin font for automatic switching
\newfontfamily\englishfont{$if(sansfont)$$sansfont$$else$Liberation Serif$endif$}[
  Ligatures=TeX,
  Scale=MatchLowercase
]

% Automatic font switching: Switch to English font for Latin characters
\setTransitionsForLatin{
  \begingroup\englishfont
}{
  \endgroup
}

% Unicode-aware PDF setup
\usepackage[unicode]{hyperref}
\hypersetup{
  pdfencoding=auto,
  bookmarksopen=true,
  bookmarksopenlevel=1
}
$else$
% --- STANDARD FONT SETUP (ORIGINAL WORKING CODE) ---
% Standard font setup for non-script-switching languages
$if(mainfont)$
    $if(mainfontoptions)$
    \setmainfont[$for(mainfontoptions)$$mainfontoptions$$sep$,$endfor$]{$mainfont$}
    $else$
    \setmainfont{$mainfont$}
    $endif$
$endif$
$if(sansfont)$
    $if(sansfontoptions)$
    \setsansfont[$for(sansfontoptions)$$sansfontoptions$$sep$,$endfor$]{$sansfont$}
    $else$
    \setsansfont{$sansfont$}
    $endif$
$endif$
$if(seriffont)$
    % Note: fontspec doesn't have \setseriffont, serif fonts are handled by \setmainfont
$endif$

% Load hyperref for all documents (not just Hindi)
\ifxetex
  \usepackage[unicode]{hyperref}
  \hypersetup{
    pdfencoding=auto,
    bookmarksopen=true,
    bookmarksopenlevel=1
  }
\fi
$endif$


$if(monofont)$
    $if(monofontoptions)$
    \setmonofont[Mapping=tex-ansi,$for(monofontoptions)$$monofontoptions$$sep$,$endfor$]{$monofont$}
    $else$
    \setmonofont[Mapping=tex-ansi]{$monofont$}
    $endif$
$endif$
$if(mathfont)$
    % Note: \setmathfont requires unicode-math package, which we're not using
    % Math fonts are handled automatically by the main font setup
$endif$

\fi

% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\usepackage{xcolor}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\hypersetup{
  $if(title-meta)$
  pdftitle={$title-meta$},
  $endif$
  $if(author-meta)$
  pdfauthor={$author-meta$},
  $endif$
  $if(lang)$
  pdflang={$lang$},
  $endif$
  $if(subject)$
  pdfsubject={$subject$},
  $endif$
  $if(keywords)$
  pdfkeywords={$keywords$},
  $endif$
  $if(colorlinks)$
  colorlinks=true,
  linkcolor=$if(linkcolor)$$linkcolor$$else$Maroon$endif$,
  filecolor=$if(filecolor)$$filecolor$$else$Maroon$endif$,
  citecolor=$if(citecolor)$$citecolor$$else$Blue$endif$,
  urlcolor=$if(urlcolor)$$urlcolor$$else$Blue$endif$,
  $else$
  hidelinks,
  $endif$
  pdfcreator={LaTeX via pandoc}}

\urlstyle{same} % disable monospaced font for URLs
$if(verbatim-in-note)$
\usepackage{fancyvrb}
$endif$
\usepackage{calc} % for calculating minipage widths
$if(beamer)$
$if(background-image)$
\usepackage{tikz}
$endif$
\usepackage{pgfpages}
\setbeamertemplate{caption}[numbered]
\setbeamertemplate{caption label separator}{: }
\setbeamercolor{caption name}{fg=normal text.fg}
$if(beamer-theme)$
\usetheme[$for(beamer-themeoptions)$$beamer-themeoptions$$sep$,$endfor$]{$beamer-theme$}
$endif$
$if(beamer-colortheme)$
\usecolortheme{$beamer-colortheme$}
$endif$
$if(beamer-fonttheme)$
\usefonttheme{$beamer-fonttheme$}
$endif$
$if(beamer-innertheme)$
\useinnertheme{$beamer-innertheme$}
$endif$
$if(beamer-outertheme)$
\useoutertheme{$beamer-outertheme$}
$endif$
$else$
$if(geometry)$
\usepackage[$for(geometry)$$geometry$$sep$,$endfor$]{geometry}
$endif$
$if(logo)$
\usepackage{graphicx}
$endif$
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
$endif$
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
$if(numbersections)$
\setcounter{secnumdepth}{$if(secnumdepth)$$secnumdepth$$else$5$endif$}
$else$
\setcounter{secnumdepth}{-\maxdimen} % remove section numbering
$endif$
$if(beamer)$
$else$
$if(block-headings)$
% Make \paragraph and \subparagraph free-standing
\ifx\paragraph\undefined\else
  \let\oldparagraph\paragraph
  \renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
  \let\oldsubparagraph\subparagraph
  \renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi
$endif$
$endif$
$if(pagestyle)$
\pagestyle{$pagestyle$}
$endif$

% Add packages for advanced table support
\RequirePackage{longtable,booktabs}      % Required for \toprule, \midrule, \bottomrule in tables
\RequirePackage{graphicx}              % Required for \includegraphics
% Add packages for advanced table support
\RequirePackage{calc}
\RequirePackage{array}
\RequirePackage{ragged2e}

% --- Chapter and section command definitions ---
% These need to be defined after the document class but before they're used
\makeatletter
% Define chapter and section commands to prevent undefined errors
\providecommand{\thechapter}{}
\providecommand{\@chapapp}{}
\providecommand{\chaptertitlename}{Chapter}

% Remove all section numbering to match the desired style
\setcounter{secnumdepth}{-10}
\renewcommand{\thechapter}{}
\renewcommand{\thesection}{}
\renewcommand{\thesubsection}{}
\renewcommand{\thesubsubsection}{}
\def\@chapapp{}
\makeatother

$if(dir)$
\ifxetex
  % load bidi as late as possible as it modifies e.g. graphicx
  $if(latex-dir-rtl)$
  \usepackage[RTLdocument]{bidi}
  $else$
  \usepackage{bidi}
  $endif$
\fi
$endif$

% Additional RTL support for pdfTeX (simplified)
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \TeXXeTstate=1
\fi

$for(header-includes)$
$header-includes$
$endfor$

$if(title)$
\title{$title$$if(subtitle)$\\\vspace{0.5em}{\large $subtitle$}$endif$}
$endif$
$if(author)$
\author{$for(author)$$author$$sep$ \and $endfor$}
$endif$
\date{$date$}
$if(beamer)$
$if(institute)$
\institute{$for(institute)$$institute$$sep$ \and $endfor$}
$endif$
$if(titlegraphic)$
\titlegraphic{\includegraphics{$titlegraphic$}}
$endif$
$if(logo)$
\logo{\includegraphics[height=\paperheight]{$logo$}}
$endif$
$endif$

\begin{document}
$if(beamer)$
$if(background-image)$
\usebackgroundtemplate{%
\includegraphics[width=\paperwidth,height=\paperheight]{$background-image$}%
}
$endif$
$if(title)$
\frame{\titlepage}
$endif$

$for(include-before)$
$include-before$

$endfor$
$else$
$if(title)$
$if(beamer)$
\frame{\titlepage}
$else$
\maketitle
$endif$
$if(abstract)$
\begin{abstract}
$abstract$
\end{abstract}
$endif$
$endif$

$for(include-before)$
$include-before$

$endfor$
$if(toc)$
$if(toc-title)$
\renewcommand*\contentsname{$toc-title$}
$endif$
$if(beamer)$
\begin{frame}[allowframebreaks]
$if(toc-title)$
  \frametitle{$toc-title$}
$endif$
  \tableofcontents[hideallsubsections]
\end{frame}
$else$
{
$if(colorlinks)$
\hypersetup{linkcolor=$if(toccolor)$$toccolor$$else$$endif$}
$endif$
\setcounter{tocdepth}{$if(toc-depth)$$toc-depth$$else$3$endif$}
\tableofcontents
}
$endif$
$endif$
$if(lof)$
\listoffigures
$endif$
$if(lot)$
\listoftables
$endif$
$if(linestretch)$
\setstretch{$linestretch$}
$endif$
$if(has-frontmatter)$
\mainmatter
$endif$
$endif$

$body$

$if(has-frontmatter)$
\backmatter
$endif$
$for(include-after)$
$include-after$

$endfor$
\end{document}
