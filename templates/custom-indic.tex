% Custom LaTeX template for Publisher-Grade Tamil Typography
% Optimized for XeLaTeX + Pandoc with Polyglossia
% Version 2.0 - Enhanced for professional Tamil publishing

\documentclass[$if(fontsize)$$fontsize$,$endif$$for(classoption)$$classoption$$sep$,$endfor$]{$documentclass$}

% Essential packages
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e}

% XeLaTeX-specific setup for Tamil
\ifxetex
  \usepackage{fontspec}
  
  % POLYGLOSSIA: Modern language support for XeLaTeX
  \usepackage{polyglossia}
  
  % Set Tamil as main language with proper configuration
  \setdefaultlanguage[numerals=devanagari]{tamil}
  \setotherlanguage{english}
  
  % FONTS: Publisher-grade Tamil fonts with complete OpenType features
  % Primary Tamil font with advanced typography features
  \setmainfont{$if(mainfont)$$mainfont$$else$Noto Serif Tamil$endif$}[
    Renderer=HarfBuzz,
    Script=Tamil,
    Language=Tamil,
    Ligatures={Required,Common,Contextual},
    % CRITICAL: Full OpenType feature set for Tamil
    RawFeature={+kern,+liga,+clig,+dlig,+rlig,+calt,+ccmp,+locl,+mark,+mkmk,+akhn,+blwf,+half,+pstf,+vatu},
    % Typography refinements
    Contextuals=Alternate,
    % Letter spacing optimization for Tamil
    LetterSpace=0.0,
    WordSpace=1.0,
    PunctuationSpace=1.0,
    Scale=1.0
  ]
  
  % English/Latin font for mixed content
  \newfontfamily\englishfont{$if(romanfont)$$romanfont$$else$Libertinus Serif$endif$}[
    Renderer=HarfBuzz,
    Ligatures={Required,Common,Rare},
    RawFeature={+kern,+liga,+clig,+dlig,+onum,+pnum},
    Scale=MatchLowercase,
    LetterSpace=0.0,
    WordSpace=1.0
  ]
  
  % Monospace font for code (if needed)
  \setmonofont{$if(monofont)$$monofont$$else$Inconsolata$endif$}[
    Scale=MatchLowercase,
    Contextuals=Alternate
  ]
  
  % MICROTYPE: Limited but optimized settings for XeLaTeX
  \usepackage{microtype}
  \microtypesetup{
    activate=true,
    protrusion=true,
    expansion=false,  % Not fully supported in XeLaTeX
    spacing=true,
    tracking=false,
    kerning=true
  }
  
  % Tamil-specific microtypography
  \SetProtrusion
    { encoding = *,
      family   = * }
    { "0964 = { ,800}, % Tamil danda
      "0965 = { ,800}, % Tamil double danda
      "0BE6 = {300,300}, % Tamil digit zero
      "0BE7 = {200,300}, % Tamil digit one
      "002D = {300,500}, % Hyphen
      "2013 = {300,400}, % En-dash
      "2014 = {200,300}  % Em-dash
    }

\else
  % Fallback for non-XeLaTeX engines
  \usepackage[utf8]{inputenc}
  \usepackage[T1]{fontenc}
  \usepackage{lmodern}
\fi

% TYPOGRAPHY: Publisher-grade settings for Tamil
% Optimized line spacing for Tamil script
\linespread{1.12}  % Slightly increased for Tamil readability

% Paragraph formatting
\setlength{\parindent}{1.8em}  % Traditional Tamil paragraph indent
\setlength{\parskip}{0.25em plus 0.1em minus 0.05em}

% WORD SPACING AND JUSTIFICATION: Critical for Tamil
% More restrictive settings for professional appearance
\tolerance=800        % Tighter tolerance for better word spacing
\pretolerance=200     % First pass tolerance
\emergencystretch=1.2em  % Conservative emergency stretch

% Hyphenation: Disabled for Tamil (not linguistically appropriate)
\hyphenpenalty=10000
\exhyphenpenalty=10000
\binoppenalty=700
\relpenalty=500

% Widow and orphan control
\widowpenalty=10000
\clubpenalty=10000
\displaywidowpenalty=10000

% Page breaking
\raggedbottom
\parfillskip=0pt plus 1fil

% Better justification algorithm
\leftskip=0pt plus 0.1em
\rightskip=0pt plus 0.1em
\spaceskip=0pt plus 0.1em minus 0.05em
\xspaceskip=0pt plus 0.15em minus 0.05em

% QUOTATION MARKS: Tamil-appropriate
\usepackage{csquotes}
\DeclareQuoteStyle{tamil}
  {\textquotedblright}{\textquotedblleft}
  {\textquoteright}{\textquoteleft}

% Page setup
\makeatletter
\def\@oddfoot{\hfil\thepage\hfil}
\def\@evenfoot{\hfil\thepage\hfil}
\def\@oddhead{}
\def\@evenhead{}
\makeatother

\pagestyle{plain}

% Unicode-aware PDF setup
\usepackage[unicode,bookmarks=true]{hyperref}
\hypersetup{
  pdfencoding=auto,
  bookmarksopen=true,
  bookmarksopenlevel=2,
  unicode=true,
  pdftitle={$if(title-meta)$$title-meta$$else$$if(title)$$title$$endif$$endif$},
  pdfauthor={$if(author-meta)$$author-meta$$else$$if(author)$$author$$endif$$endif$},
  pdfsubject={$if(subject)$$subject$$else$$if(title)$$title$$endif$$endif$},
  pdfkeywords={$if(keywords)$$for(keywords)$$keywords$$sep$, $endfor$$endif$},
  pdfcreator={Enhanced Tamil Typography},
  pdfproducer={XeLaTeX with Polyglossia},
  colorlinks=false,
  hidelinks=true
}

% Page geometry
$if(paperwidth)$
\usepackage[
  paperwidth=$paperwidth$,
  paperheight=$paperheight$,
  left=$leftmargin$,
  right=$rightmargin$,
  top=$topmargin$,
  bottom=$bottommargin$,
  footskip=$footskip$,
  bindingoffset=0pt
]{geometry}
$endif$

% Page style customization
$if(pagestyle)$
\pagestyle{$pagestyle$}
$endif$

% Section formatting with Tamil support
$if(secstyle)$
\usepackage{titlesec}
\titleformat{\chapter}[display]
  {\normalfont\huge\bfseries\centering}
  {\chaptertitlename\ \thechapter}
  {1ex}
  {}
\titleformat{\section}
  {\normalfont\Large\bfseries}
  {\thesection}
  {1em}
  {}
\titleformat{\subsection}
  {\normalfont\large\bfseries}
  {\thesubsection}
  {1em}
  {}
$endif$

% Spacing customization
$if(setspace)$
\usepackage{setspace}
\setstretch{$setspace$}
$endif$

% Lists with proper Tamil formatting
\usepackage{enumitem}
\setlist{
  itemsep=0.25em,
  parsep=0.1em,
  topsep=0.5em,
  partopsep=0.1em,
  leftmargin=2em
}

% Tight list for Pandoc
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}%
  \setlength{\parskip}{0pt}%
}

% Section numbering
$if(secnumdepth)$
\setcounter{secnumdepth}{$secnumdepth$}
$endif$

% TOC depth
$if(tocdepth)$
\setcounter{tocdepth}{$tocdepth$}
$endif$

% Tables and graphics with Tamil support
\usepackage{longtable}
\usepackage{booktabs}
\usepackage{array}
\usepackage{graphicx}
\usepackage{calc}

% Better table formatting for Tamil content
\renewcommand{\arraystretch}{1.1}

% Front/Main/Back matter
\renewcommand{\frontmatter}{%
  \cleardoublepage
  \pagenumbering{roman}
  \setcounter{page}{1}
  \pagestyle{plain}
}

\renewcommand{\mainmatter}{%
  \cleardoublepage
  \pagenumbering{arabic}
  \setcounter{page}{1}
  \pagestyle{plain}
}

\renewcommand{\backmatter}{%
  \cleardoublepage
  \pagestyle{plain}
}

% Tamil-specific commands and environments
\newcommand{\tamilquote}[1]{\textquotedblright#1\textquotedblleft}
\newcommand{\tamilemph}[1]{\textbf{#1}}  % Bold emphasis for Tamil

% Verse environment for Tamil poetry
\newenvironment{tamilverse}
{\begin{verse}\raggedright}
{\end{verse}}

% DOCUMENT START
\begin{document}

% Set Tamil language environment
\begin{tamil}

% Table of Contents
$if(toc)$
{
\hypersetup{linkcolor=black}
\setcounter{tocdepth}{$toc-depth$}
\tableofcontents
}
$endif$

% Main content with Tamil typography
$body$

\end{tamil}

% Bibliography
$if(bibliography)$
\begin{english}
\bibliography{$bibliography$}
\end{english}
$endif$

\end{document}