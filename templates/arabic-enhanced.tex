% ===============================
% arabic-enhanced.tex â€” Pandoc template (XeLaTeX, RTL Arabic)
% Production-ready: uses modern babel for full RTL layout, mixed-language handling,
% and Arabic-Indic numerals. No bidi/ucharclasses required.
% ===============================

$if(documentclass)$
\documentclass[$for(classoptions)$$classoptions$$sep$,$endfor$]{$documentclass$}
$else$
\documentclass[12pt,oneside,openany]{book}
$endif$

% ---------- Engine detection ----------
\usepackage{ifxetex,ifluatex}
\newif\ifxetexorluatex
\ifxetex \xetexorluatextrue \fi
\ifluatex \xetexorluatextrue \fi

% ---------- Fonts & encodings ----------
\ifxetexorluatex
  \usepackage{fontspec}
\else
  % Fallback (not expected in this template)
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\fi

% ---------- Essential packages ----------
\usepackage{amssymb,amsmath}
\usepackage{fixltx2e}

% ---------- Geometry (let Pandoc inject page geometry files or variables) ----------
$if(geometry)$
  \usepackage[$for(geometry)$$geometry$$sep$,$endfor$]{geometry}
$endif$

% ---------- Microtype (harmless with Arabic fonts; improves Latin text) ----------
\IfFileExists{microtype.sty}{\usepackage{microtype}}{}

% ---------- Hyperref (safe defaults) ----------
\IfFileExists{hyperref.sty}{\usepackage{hyperref}}{}
$if(colorlinks)$
  \hypersetup{colorlinks, linkcolor=black, citecolor=black, urlcolor=black}
$else$
  \hypersetup{hidelinks}
$endif$

% ---------- BABEL: Arabic main, English secondary; full RTL support ----------
% bidi=basic lets babel own paragraph direction; mapdigits makes Arabic-Indic numerals the default
\usepackage[bidi=basic]{babel}
\babelprovide[main, import, mapdigits]{arabic}
\babelprovide[import]{english}

% ---------- Fonts selection via babel-aware \babelfont ----------
% Arabic main font
$if(mainfont)$
  \babelfont{rm}[
    Script=Arabic,
    Language=Arabic,
    Renderer=HarfBuzz,
    Scale=MatchLowercase
  ]{$mainfont$}
$else$
  \babelfont{rm}[
    Script=Arabic,
    Language=Arabic,
    Renderer=HarfBuzz,
    Scale=MatchLowercase
  ]{Noto Sans Arabic}
$endif$

% Optional Latin (English) font override
$if(latinfont)$
  \babelfont[english]{rm}{$latinfont$}
$else$
  \babelfont[english]{rm}{Liberation Serif}
$endif$

% ---------- Page numbering in Arabic-Indic digits ----------
\makeatletter
\renewcommand*\thepage{\localedigits*{\arabic{page}}}
\makeatother

% ---------- Section numbering depth ----------
$if(numbersections)$
  % Pandoc will set secnumdepth; leave as-is
$else$
  \setcounter{secnumdepth}{-10}
$endif$

% ---------- Headers/footers (optional minimal pagestyle) ----------
$if(pagestyle)$
  \pagestyle{$pagestyle$}
$else$
  % Default to empty unless user overrides
  \pagestyle{plain}
$endif$

% ---------- Title metadata ----------
$if(title)$
  \title{$title$}
$endif$
$if(subtitle)$
  \providecommand{\subtitle}[1]{\gdef\@subtitle{#1}}
  \subtitle{$subtitle$}
$endif$
$if(author)$
  \author{$for(author)$$author$$sep$ \\ $endfor$}
$endif$
$if(date)$
  \date{$date$}
$else$
  \date{\today}
$endif$

% ---------- Header includes (from Pandoc) ----------
$for(header-includes)$
$header-includes$
$endfor$

% ---------- TOC settings ----------
$if(toc-title)$
  \addto\captionsarabic{\renewcommand{\contentsname}{$toc-title$}}
$endif$

% ---------- Graphics support ----------
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}

% ---------- Verbatim/code support ----------
\usepackage{fancyvrb}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}

\begin{document}

% ---------- Title page ----------
$if(title)$
\maketitle
$endif$

% ---------- Table of contents ----------
$if(toc)$
{\hypersetup{hidelinks}\tableofcontents}
$endif$

% NOTE: You can insert \frontmatter / \mainmatter via raw LaTeX blocks from Pandoc Markdown
% to switch Roman/Arabic numerals or separate front matter. This template does not fight that.

% ---------- Body ----------
$body$

% ---------- End matter / Bibliography ----------
$if(bibliography)$
$if(natbib)$
\bibliographystyle{$if(biblio-style)$$biblio-style$$else$plainnat$endif$}
\bibliography{$for(bibliography)$$bibliography$$sep$, $endfor$}
$endif$
$if(biblatex)$
\printbibliography[heading=bibintoc]
$endif$
$endif$

% ---------- Include-after (Pandoc) ----------
$for(include-after)$
$include-after$
$endfor$

\end{document}