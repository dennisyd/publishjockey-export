% ===============================
% arabic-enhanced.tex â€” Pandoc template (XeLaTeX RTL with polyglossia)
% Fixes: bidi/float load-order error; no external 'bidi' package used
% ===============================

$if(documentclass)$
\documentclass[$for(classoptions)$$classoptions$$sep$,$endfor$]{$documentclass$}
$else$
\documentclass[12pt,oneside,openany]{book}
$endif$

% ---------- PRELOAD float (must come before anything that might pull bidi) ----------
\IfFileExists{float.sty}{\RequirePackage{float}}{}

% ---------- Engine detection ----------
\usepackage{ifxetex,ifluatex}
\ifxetex\else\errmessage{This template requires XeLaTeX}\fi

% ---------- Fonts & language engine ----------
\usepackage{fontspec}
\usepackage{polyglossia}

% Main language: Arabic (RTL); secondary: English (LTR)
\setmainlanguage{arabic}
\setotherlanguage{english}

% ---------- Font setup ----------
% Arabic main font
$if(mainfont)$
  \newfontfamily\arabicfont[
    Script=Arabic,
    Language=Arabic,
    Renderer=HarfBuzz,
    Scale=MatchLowercase
  ]{$mainfont$}
$else$
  \newfontfamily\arabicfont[
    Script=Arabic,
    Language=Arabic,
    Renderer=HarfBuzz,
    Scale=MatchLowercase
  ]{Noto Sans Arabic}
$endif$

% Latin font for English runs (optional override)
$if(latinfont)$
  \newfontfamily\englishfont{$latinfont$}
$else$
  \newfontfamily\englishfont{Latin Modern Roman}
$endif$

% ---------- Geometry (handled entirely by Pandoc include-in-header) ----------
% Note: No geometry package loaded here to avoid conflicts with Pandoc injection

% ---------- Microtype & Hyperref ----------
\IfFileExists{microtype.sty}{\usepackage{microtype}}{}
\IfFileExists{hyperref.sty}{\usepackage{hyperref}}{}
$if(colorlinks)$
  \hypersetup{colorlinks, linkcolor=black, citecolor=black, urlcolor=black}
$else$
  \hypersetup{hidelinks}
$endif$

% ---------- Page numbering: Arabic-Indic digits ----------
\makeatletter
\renewcommand*\thepage{\arabicdigits{\arabic{page}}}
\makeatother

% ---------- Section numbering depth ----------
$if(numbersections)$
  % Pandoc sets secnumdepth when needed
$else$
  \setcounter{secnumdepth}{-10}
$endif$

% ---------- Pagestyle ----------
$if(pagestyle)$
  \pagestyle{$pagestyle$}
$else$
  \pagestyle{plain}
$endif$

% ---------- Title metadata ----------
$if(title)$\title{$title$}$endif$
$if(subtitle)$
  \providecommand{\subtitle}[1]{\gdef\@subtitle{#1}}
  \subtitle{$subtitle$}
$endif$
$if(author)$\author{$for(author)$$author$$sep$ \\ $endfor$}$endif$
$if(date)$\date{$date$}$else$\date{\today}$endif$

% ---------- Header includes (from Pandoc) ----------
$for(header-includes)$
$header-includes$
$endfor$

% ---------- TOC settings ----------
$if(toc-title)$
  % Localize TOC title for Arabic
  \addto\captionsarabic{\renewcommand{\contentsname}{$toc-title$}}
$endif$

\begin{document}

% ---------- Title ----------
$if(title)$\maketitle$endif$

% ---------- Table of contents ----------
$if(toc)$
{\hypersetup{hidelinks}\tableofcontents}
$endif$

% NOTE: Use raw LaTeX blocks in Markdown to insert \frontmatter / \mainmatter if desired.

% ---------- Body ----------
$body$

% ---------- Bibliography ----------
$if(bibliography)$
$if(natbib)$
\bibliographystyle{$if(biblio-style)$$biblio-style$$else$plainnat$endif$}
\bibliography{$for(bibliography)$$bibliography$$sep$, $endfor$}
$endif$
$if(biblatex)$
\printbibliography[heading=bibintoc]
$endif$
$endif$

% ---------- Include-after (Pandoc) ----------
$for(include-after)$
$include-after$
$endfor$

\end{document}