% Custom LaTeX template for PublishJockey
% This template handles all formatting for PDF exports

\documentclass[$if(fontsize)$$fontsize$,$endif$$for(classoption)$$classoption$$sep$,$endfor$]{$documentclass$}

% Note: Using book class for proper front/main matter handling

\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript



% --- Simple page numbering without fancyhdr ---
% Use basic LaTeX page numbering that's more reliable
\makeatletter
\def\@oddfoot{\hfil\thepage\hfil}
\def\@evenfoot{\hfil\thepage\hfil}
\def\@oddhead{}
\def\@evenhead{}
\makeatother

% Set page style to plain for simple centered page numbers
\pagestyle{plain}

\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[$if(fontenc)$$fontenc$$else$T1$endif$]{fontenc}
  \usepackage[utf8]{inputenc}
$if(euro)$
  \usepackage{eurosym}
$endif$
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
  
  % ==== Engine-safe microtype ====
  \usepackage{iftex}
  \ifPDFTeX
    % pdfTeX: full microtype
    \usepackage[protrusion,expansion,tracking,final]{microtype}
  \else\ifLuaTeX
    % LuaLaTeX: full microtype
    \usepackage[protrusion,expansion,tracking,final]{microtype}
  \else
    % XeLaTeX: load microtype but deactivate features that aren't supported
    \usepackage{microtype}
    \microtypesetup{
      activate=false,
      protrusion=false,
      expansion=false,
      spacing=false,
      tracking=false,
      kerning=false
    }
  \fi\fi
  % =================================
  
  
  % Load packages for enhanced drop caps support
  \usepackage{lettrine}
  \usepackage{xcolor}
  % Enhanced lettrine configuration for better drop cap rendering
  \renewcommand{\LettrineFontHook}{\fontsize{42}{48}\selectfont\color{black}\bfseries}
  \renewcommand{\LettrineTextFont}{\scshape}
  \setcounter{DefaultLines}{3}
  \setcounter{DefaultDepth}{0}
  % Additional lettrine styling options
  \renewcommand{\DefaultLhang}{0.3}
  \renewcommand{\DefaultLoversize}{0.15}
$for(fontfamilies)$
  \newfontfamily{$fontfamilies.name$}[$fontfamilies.options$]{$fontfamilies.font$}
$endfor$
$if(euro)$
  \newcommand{\euro}{€}
$endif$

% --- MODULAR MULTI-SCRIPT FONT SETUP ---
% Clean, reliable font configuration for all supported scripts
% Note: Automatic script transitions disabled due to template complexity
\ifxetex
  % English/Latin font (default for most documents)
  \newfontfamily\englishfont{Liberation Serif}[Ligatures=TeX,Scale=MatchLowercase]

  % Script-specific font definitions (modular approach)
  \newfontfamily\cyrillicfont[Script=Cyrillic]{Liberation Serif}[Ligatures=TeX,Scale=MatchLowercase]
  \newfontfamily\greekfont[Script=Greek]{Liberation Serif}[Ligatures=TeX,Scale=MatchLowercase]

  % Hindi/Devanagari font (FIXED CONFIGURATION)
  \newfontfamily\devanagarifont{Noto Sans Devanagari}[
    Script=Devanagari,
    Renderer=HarfBuzz,
    Ligatures=Required,
    Language=Hindi
  ]

  % Tamil font (FIXED CONFIGURATION)
  \newfontfamily\tamilfont{Noto Sans Tamil}[
    Script=Tamil,
    Renderer=HarfBuzz,
    Ligatures=Required,
    Language=Tamil
  ]

  % Other South Asian scripts
  \newfontfamily\bengalifont{Noto Sans Bengali}[
    Script=Bengali,
    Renderer=HarfBuzz,
    Ligatures=Required,
    Language=Bengali
  ]

  \newfontfamily\gurmukhifont{Noto Sans Gurmukhi}[
    Script=Gurmukhi,
    Renderer=HarfBuzz,
    Ligatures=Required,
    Language=Punjabi
  ]

  % RTL languages
  \newfontfamily\arabicfont{Noto Sans Arabic}[
    Script=Arabic,
    Renderer=HarfBuzz,
    Ligatures=Required,
    Language=Arabic
  ]

  \newfontfamily\hebrewfont{Noto Sans Hebrew}[
    Script=Hebrew,
    Renderer=HarfBuzz,
    Ligatures=Required,
    Language=Hebrew
  ]


\fi

% --- CLEAN FONT SETUP COMPLETE ---

% Unicode-aware PDF setup
\usepackage[unicode]{hyperref}
\hypersetup{
  pdfencoding=auto,
  bookmarksopen=true,
  bookmarksopenlevel=1,
  pdftitle={$if(title-meta)$$title-meta$$else$$if(title)$$title$$else$Document$endif$$endif$},
  pdfauthor={$if(author-meta)$$author-meta$$else$$if(author)$$author$$else$$endif$$endif$},
  pdfsubject={$if(subject)$$subject$$else$$if(title)$$title$$else$$endif$$endif$},
  pdfkeywords={$if(keywords)$$for(keywords)$$keywords$$sep$, $endfor$$endif$},
  pdfcreator={PublishJockey.com},
  pdfproducer={PublishJockey.com}
}

% Standard font setup for all languages
$if(mainfont)$
    $if(mainfontoptions)$
    \setmainfont[$for(mainfontoptions)$$mainfontoptions$$sep$,$endfor$]{$mainfont$}
    $else$
    \setmainfont{$mainfont$}
    $endif$
$endif$
$if(sansfont)$
    $if(sansfontoptions)$
    \setsansfont[$for(sansfontoptions)$$sansfontoptions$$sep$,$endfor$]{$sansfont$}
    $else$
    \setsansfont{$sansfont$}
    $endif$
$endif$

% Hyperref setup complete


$if(monofont)$
    $if(monofontoptions)$
    \setmonofont[Mapping=tex-ansi,$for(monofontoptions)$$monofontoptions$$sep$,$endfor$]{$monofont$}
    $else$
    \setmonofont[Mapping=tex-ansi]{$monofont$}
    $endif$
$endif$
$if(mathfont)$
    % Note: \setmathfont requires unicode-math package, which we're not using
    % Math fonts are handled automatically by the main font setup
$endif$

\fi

% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% Microtype removed due to XeLaTeX compatibility issues
% Core typography improvements still active below

% Typography optimizations complete

% RTL language setup (simplified - no polyglossia for now)
$if(dir)$
\ifxetex
  % Simple RTL font setup without polyglossia
  $if(lang.arabic)$
  \newfontfamily\arabicfont[Script=Arabic]{Noto Sans Arabic}
  $endif$
  $if(lang.hebrew)$
  \newfontfamily\hebrewfont[Script=Hebrew]{Noto Sans Hebrew}
  $endif$
\fi
$endif$

% Basic RTL support for pdfTeX (simplified)
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \TeXXeTstate=1
\fi

% CUSTOM PACKAGES FOR BETTER BOOK FORMATTING
\usepackage{sectsty}               % For section formatting
\usepackage{titlesec}              % Advanced title formatting
\usepackage{tocloft}               % TOC formatting
% fancyhdr removed - using simple page numbering instead
\usepackage{tocbibind}
\usepackage{etoolbox}              % Programming tools
\usepackage{bookmark}              % PDF bookmarks
\usepackage{longtable}             % Required for markdown tables
\usepackage{setspace}              % Required for \setstretch
\usepackage{booktabs}              % Required for \toprule, \midrule, \bottomrule in tables
\usepackage{graphicx}              % Required for \includegraphics
% Add packages for advanced table support
\RequirePackage{calc}
\RequirePackage{array}
\RequirePackage{ragged2e}

% --- Additional packages ---
% geometry package is loaded dynamically via --include-in-header for custom page sizes
% Removed duplicate fancyhdr and titlesec - already loaded above
\usepackage{setspace}
\usepackage{enumitem}
\usepackage{microtype}
\usepackage{xcolor}
\usepackage{calc}
\usepackage{array}
\usepackage{ragged2e}

% --- Chapter and section command definitions ---
% These need to be defined after the document class but before they're used
\makeatletter
% Define chapter and section commands to prevent undefined errors
\providecommand{\thechapter}{}
\providecommand{\@chapapp}{}
\providecommand{\chaptertitlename}{Chapter}

% Remove all section numbering to match the desired style
\setcounter{secnumdepth}{-10}
\renewcommand{\thechapter}{}
\renewcommand{\thesection}{}
\renewcommand{\thesubsection}{}
\renewcommand{\thesubsubsection}{}
\def\@chapapp{}
\makeatother

% --- Page setup ---
% Load geometry package and use complete geometry variables if provided
$if(paperwidth)$
\usepackage[
  paperwidth=$paperwidth$,
  paperheight=$paperheight$,
  left=$leftmargin$,
  right=$rightmargin$,
  top=$topmargin$,
  bottom=$bottommargin$,
  footskip=$footskip$,
  bindingoffset=0pt
]{geometry}
$else$
% Geometry is handled via --include-in-header files for better control
$endif$

% --- Header/footer setup ---
$if(pagestyle)$
\pagestyle{$pagestyle$}
$endif$

% --- Title formatting ---
$if(secstyle)$
\titleformat{\chapter}{\huge\bfseries\filcenter}{}{0em}{}
$endif$

% --- Spacing and formatting ---
$if(setspace)$
\setstretch{$setspace$}
$endif$

% --- List formatting ---
\setlist{nolistsep}

% --- Enhanced typography and spacing control ---
% Widow/orphan control
\widowpenalty=10000
\clubpenalty=10000
\displaywidowpenalty=10000

% Emergency stretch for better justification
\emergencystretch=3em

% Line breaking tolerance and penalties
\tolerance=2000
\pretolerance=100
\hyphenpenalty=50
\exhyphenpenalty=50
\adjdemerits=10000

% Script-specific spacing optimization
\ifxetex
  % Tighter spacing for Russian and Greek text
  \usepackage{hyphenat}
  \hyphenation{рус-ский-я-зык}
  \hyphenation{ελλην-ικά}
  
  % Script-specific line breaking (tighter for Cyrillic and Greek)
  \tolerance=1500  % Tighter tolerance for Russian and Greek
  \pretolerance=50
  \hyphenpenalty=30  % More aggressive hyphenation for Russian and Greek
  \exhyphenpenalty=30
  \doublehyphendemerits=10000
  \finalhyphendemerits=5000
  
  % Script-specific word spacing optimization
  \spaceskip=0.3em plus 0.2em minus 0.1em
  \xspaceskip=0.3em plus 0.2em minus 0.1em
\fi

% Better paragraph spacing
\raggedbottom
\sloppy

% --- Pandoc tightlist environment ---
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% --- Section numbering control ---
$if(secnumdepth)$
\setcounter{secnumdepth}{$secnumdepth$}
$endif$

% --- TOC depth control ---
$if(tocdepth)$
\setcounter{tocdepth}{$tocdepth$}
$endif$

% --- Load bidi package for RTL support (must be loaded last) ---
$if(dir)$
\ifxetex
  % load bidi as late as possible as it modifies e.g. graphicx
  $if(latex-dir-rtl)$
  \usepackage[RTLdocument]{bidi}
  $else$
  \usepackage{bidi}
  $endif$
\fi
$endif$

% --- Front Matter / Main Matter Commands ---
% Define proper frontmatter command with roman numerals
\renewcommand{\frontmatter}{%
  \cleardoublepage
  \pagenumbering{roman}
  \setcounter{page}{1}
  \pagestyle{plain}
}

% Define proper mainmatter command with arabic numerals  
\renewcommand{\mainmatter}{%
  \cleardoublepage
  \pagenumbering{arabic}
  \setcounter{page}{1}
  \pagestyle{plain}
}

% Define proper backmatter command  
\renewcommand{\backmatter}{%
  \cleardoublepage
  \pagestyle{plain}
}

% --- Document begin ---
\begin{document}

% --- Title page setup (disabled - user handles title in content) ---
% $if(title)$
% \title{$title$}
% $endif$
% $if(author)$
% \author{$author$}
% $endif$
% $if(date)$
% \date{$date$}
% $endif$
% 
% $if(title)$
% \maketitle
% $endif$

% --- Table of Contents ---
% TOC is generated in bookAssemblerPdf.js with proper language translation
$if(toc)$
\tableofcontents
$endif$

% --- Main content ---
$body$

% --- Bibliography ---
$if(bibliography)$
\bibliography{$bibliography$}
$endif$

\end{document}