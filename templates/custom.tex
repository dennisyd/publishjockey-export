% Custom LaTeX template for PublishJockey
% This template handles all formatting for PDF exports

\documentclass[$if(fontsize)$$fontsize$,$endif$$if(papersize)$$papersize$paper,$endif$$for(classoption)$$classoption$$sep$,$endfor$]{$documentclass$}

% Note: Using book class for proper front/main matter handling

\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[$if(fontenc)$$fontenc$$else$T1$endif$]{fontenc}
  \usepackage[utf8]{inputenc}
$if(euro)$
  \usepackage{eurosym}
$endif$
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
$for(fontfamilies)$
  \newfontfamily{$fontfamilies.name$}[$fontfamilies.options$]{$fontfamilies.font$}
$endfor$
$if(euro)$
  \newcommand{\euro}{â‚¬}
$endif$

% --- Additional font setup for RTL languages and Hindi ---
$if(dir)$
\ifxetex
  % Ensure proper font loading for RTL languages
  $if(mainfont)$
  \setmainfont{$mainfont$}
  $endif$
  % Additional font features for RTL languages
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
  % Explicit font loading for RTL languages
  \newfontfamily\arabicfont[Script=Arabic]{Noto Sans Arabic}
  \newfontfamily\hebrewfont[Script=Hebrew]{Noto Sans Hebrew}
\fi
$endif$

% --- FONT SETUP ---
$if(polyglossia)$
% Hindi language setup with polyglossia
\ifxetex
  \usepackage{polyglossia}
  \setdefaultlanguage{hindi}
  \setotherlanguage{english}
  
  % Set up main Hindi font
  \setmainfont{Noto Sans Devanagari}[
    Script=Devanagari,
    Ligatures=TeX,
    Scale=MatchLowercase,
    Language=Hindi
  ]
  
  % Set up fallback fonts for Latin script
  \setsansfont{Liberation Serif}[
    Script=Latin,
    Ligatures=TeX,
    Scale=MatchLowercase
  ]
  
  % Note: fontspec doesn't have \setseriffont, we use \setmainfont for serif
  % The main font is already set to Noto Sans Devanagari above
  
  % Unicode-aware PDF setup
  \usepackage[unicode]{hyperref}
  \hypersetup{
    pdfencoding=auto,
    bookmarksopen=true,
    bookmarksopenlevel=1
  }
\fi
$else$
% Standard font setup for non-Hindi languages
$if(mainfont)$
    \setmainfont[$for(mainfontoptions)$$mainfontoptions$$sep$,$endfor$]{$mainfont$}
$endif$
$if(sansfont)$
    \setsansfont[$for(sansfontoptions)$$sansfontoptions$$sep$,$endfor$]{$sansfont$}
$endif$
$if(seriffont)$
    % Note: fontspec doesn't have \setseriffont, serif fonts are handled by \setmainfont
$endif$
$endif$


$if(monofont)$
    \setmonofont[Mapping=tex-ansi$if(monofontoptions)$,$for(monofontoptions)$$monofontoptions$$sep$,$endfor$$endif$]{$monofont$}
$endif$
$if(mathfont)$
    \setmathfont(Digits,Latin,Greek)[$for(mathfontoptions)$$mathfontoptions$$sep$,$endfor$]{$mathfont$}
$endif$

\fi

% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage[$for(microtypeoptions)$$microtypeoptions$$sep$,$endfor$]{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}

% Language-specific packages for RTL support
$if(dir)$
\ifxetex
  % load bidi as late as possible as it modifies e.g. graphicx
  $if(latex-dir-rtl)$
  \usepackage[RTLdocument]{bidi}
  $else$
  \usepackage{bidi}
  $endif$
  % Additional bidirectional text support for XeLaTeX
  \usepackage{fontspec}
  \usepackage{xunicode}
  \usepackage{xltxtra}
  % Additional packages for better RTL text rendering
  \usepackage{polyglossia}
  % Set up languages with specific fonts
  \setdefaultlanguage{english}
  $if(lang.arabic)$
  \setotherlanguage{arabic}
  \newfontfamily\arabicfont[Script=Arabic]{Noto Sans Arabic}
  $endif$
  $if(lang.hebrew)$
  \setotherlanguage{hebrew}
  \newfontfamily\hebrewfont[Script=Hebrew]{Noto Sans Hebrew}
  $endif$
\fi
$endif$

% Basic RTL support for pdfTeX (simplified)
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \TeXXeTstate=1
\fi

% CUSTOM PACKAGES FOR BETTER BOOK FORMATTING
\usepackage{sectsty}               % For section formatting
\usepackage{titlesec}              % Advanced title formatting
\usepackage{tocloft}               % TOC formatting
% Removed fancyhdr to avoid conflicts with page numbering
\usepackage{tocbibind}
\usepackage{etoolbox}              % Programming tools
\usepackage{bookmark}              % PDF bookmarks
\usepackage{longtable}             % Required for markdown tables
\usepackage{setspace}              % Required for \setstretch
\usepackage{booktabs}              % Required for \toprule, \midrule, \bottomrule in tables
\usepackage{graphicx}              % Required for \includegraphics
% Add packages for advanced table support
\RequirePackage{calc}
\RequirePackage{array}
\RequirePackage{ragged2e}

% CUSTOM STYLING FOR CHAPTERS AND SECTIONS
% Make chapter titles centered
\titleformat{\chapter}[display]
  {\normalfont\huge\bfseries\centering}
  {$if(no-chapter-labels)$$else$\chaptertitlename\ \thechapter$endif$}
  {10pt}
  {\Huge}
  [\vspace{0.1cm}]  % Minimal spacing after chapter title

% Make section titles (H2) centered, large and bold
\titleformat{\section}
  {\normalfont\Large\bfseries\centering}
  {$if(numbersections)$\thesection$else$$endif$}
  {0.5em}
  {}
  [\vspace{0.1cm}]  % Minimal spacing after section title

% Make subsection titles (H3) bold and left-aligned
\titleformat{\subsection}
  {\normalfont\large\bfseries}
  {$if(numbersections)$\thesubsection$else$$endif$}
  {0.5em}
  {}

% Adjust spacing around headings
\titlespacing*{\chapter}
  {0pt}        % left margin
  {20pt}       % space before
  {10pt}       % space after - reduced further

\titlespacing*{\section}
  {0pt}        % left margin
  {0.1em}      % minimal space before
  {0.1em}      % minimal space after

\titlespacing*{\subsection}
  {0pt}        % left margin
  {2.25ex plus 1ex minus .2ex}      % space before
  {1ex plus .2ex}                   % space after

% Enable proper hyphenation
$if(dir)$
% For RTL languages, use polyglossia instead of babel
$elseif(polyglossia)$
% Hindi uses polyglossia
$else$
% Note: babel-lang is no longer automatically set to avoid LaTeX package issues
% TOC title translation is handled via YAML metadata instead
\usepackage[english]{babel}
$endif$

% Improved list typesetting
\usepackage{enumitem}
\setlist{noitemsep}

% Prevent widow and orphan lines
\widowpenalty=10000
\clubpenalty=10000

% Set line spacing
\setstretch{1.15}

% The rest of the template remains unchanged
$if(indent)$
\setlength{\parindent}{$indent$}
$else$
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
$endif$
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

$if(numbersections)$
\setcounter{secnumdepth}{$if(secnumdepth)$$secnumdepth$$else$5$endif$}
$else$
\setcounter{secnumdepth}{0}
$endif$

$if(subparagraph)$
$else$
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi
$endif$

$if(dir)$
\ifxetex
  % load bidi as late as possible as it modifies e.g. graphicx
  $if(latex-dir-rtl)$
  \usepackage[RTLdocument]{bidi}
  $else$
  \usepackage{bidi}
  $endif$
\fi
$endif$

% Additional RTL support for pdfTeX (simplified)
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \TeXXeTstate=1
\fi

$for(header-includes)$
$header-includes$
$endfor$

$if(title)$
\title{$title$$if(subtitle)$\\\vspace{0.5em}{\large $subtitle$}$endif$}
$endif$
$if(author)$
\author{$for(author)$$author$$sep$ \and $endfor$}
$endif$
\date{$date$}

% Create a custom title page
\usepackage{titling}
\newcommand{\customtitlepage}{
  \begin{titlepage}
    % Apply empty page style directly without using \thispagestyle
    \pagestyle{empty}
    \begin{center}
    \vspace*{2cm}
    {\Huge\bfseries $title$\par}
    $if(subtitle)$
    \vspace{0.5cm}
    {\Large $subtitle$\par}
    $endif$
    \vspace{2cm}
    $if(author)$
    {\large By $author$\par}
    $endif$
    $if(isbn)$
    \vspace{0.5cm}
    {\large ISBN: $isbn$\par}
    $endif$
    $if(date)$
    \vspace{1cm}
    {\large $date$\par}
    $endif$
    \end{center}
  \end{titlepage}
}



\begin{document}
% Start with front matter (roman numerals)
\frontmatter
\pagenumbering{roman}  % Explicitly set roman numerals
\pagestyle{plain}      % Use plain page style

$if(include-title-page)$
\customtitlepage
$endif$

$if(abstract)$
\begin{abstract}
$abstract$
\end{abstract}
$endif$

$for(include-before)$
$include-before$
$endfor$

% Table of Contents Configuration
$if(toc-title)$
\renewcommand{\contentsname}{$toc-title$}
$endif$

% Always include table of contents
$if(toc)$
{
\hypersetup{linkcolor=black}
\setcounter{tocdepth}{$if(toc-depth)$$toc-depth$$else$2$endif$}
\tableofcontents
\clearpage
}
$endif$

$if(lot)$
\listoftables
$endif$
$if(lof)$
\listoffigures
$endif$

% Main content
$body$

$if(natbib)$
$if(bibliography)$
$if(biblio-title)$
$if(book-class)$
\renewcommand\bibname{$biblio-title$}
$else$
\renewcommand\refname{$biblio-title$}
$endif$
$endif$
\bibliography{$for(bibliography)$$bibliography$$sep$,$endfor$}
$endif$
$endif$

$if(biblatex)$
\printbibliography$if(biblio-title)$[title=$biblio-title$]$endif$
$endif$

$for(include-after)$
$include-after$
$endfor$
\end{document}